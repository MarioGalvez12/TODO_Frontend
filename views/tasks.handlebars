<div class="d-flex justify-content-center container">
  <div class="col-md-8">
    <div class="card-hover-shadow-2x mb-3 card">
      <div class="card-header-tab card-header">
        <div class="card-header-title font-size-lg text-capitalize font-weight-normal">
          <i class="fa fa-tasks"></i>&nbsp;Task Lists
        </div>
      </div>
      <div class="scroll-area-sm">
        {{!-- Add Modal --}}
        <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
          aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Create a Task</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="addTitle">Title</label>
                  <input type="text" class="form-control" id="addTitle" placeholder="E.g. Buy Twitter">
                  <small class="form-text text-muted">Required</small>
                </div>
                <div class="form-group">
                  <label for="addDescription">Description</label>
                  <textarea class="form-control" id="addDescription" rows="3"
                    placeholder="E.g. Place an offer an leave"></textarea>
                </div>
                <div class="form-group">
                  <label for="addEstimated">Estimated time</label>
                  <input type="time" class="form-control" id="addEstimated">
                </div>
                <div class="form-group">
                  <label for="addStart">Task start time</label>
                  <input type="date" class="form-control" id="addStart">
                </div>
                <div class="form-group">
                  <label for="addEnd">Task end time limit</label>
                  <input type="date" class="form-control" id="addEnd">
                </div>
                <div class="form-group">
                  <label for="addImage">Image URL</label>
                  <input type="text" class="form-control" id="addImage" placeholder="E.g. https://image.com/image.jpg">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addTask()">Create task</button>
              </div>
            </div>
          </div>
        </div>
        <perfect-scrollbar class="ps-show-limits">
          <div style="position: static;" class="ps ps--active-y">
            <div class="ps-content">
              <ul class=" list-group list-group-flush">
                {{#each tasks}}
                <li class="list-group-item">
                  <div class="todo-indicator bg-primary"></div>
                  <div class="widget-content p-0">
                    <div class="widget-content-wrapper">
                      <div class="widget-content-left mr-2">
                        <div class="custom-checkbox custom-control">
                          <input class="custom-control-input" id="checkbox{{@index}}"
                            onclick="changeCompleted('{{this._id}}',this)" completed="{{this.completed}}"
                            type="checkbox">
                          <label class="custom-control-label" for="checkbox{{@index}}">&nbsp;</label>
                        </div>
                      </div>
                      {{!-- Main Modal --}}
                      <div class="modal fade" id="Modal{{@index}}" tabindex="-1" role="dialog"
                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                          <div class="card">
                            <img class="card-img-top" src="{{this.imageURL}}" alt="">
                            <div class="card-body">
                              <h5 class="card-title">{{this.title}}</h5>
                              <p class="card-text">{{this.text}}</p>
                            </div>
                            <ul class="list-group list-group-flush">
                              <li class="list-group-item">Time estimate: {{this.timeEstimate}}</li>
                              <li class="list-group-item">Start time: {{this.starTime}}</li>
                              <li class="list-group-item">End time: {{this.endTime}}</li>
                              <li class="list-group-item">Created at: {{this.createdAt}}</li>
                            </ul>
                            <div class="card-body">
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                              <button type="button" class="btn btn-primary">Edit Task</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="widget-content-left flex2">
                        <div class="widget-heading">{{this.title}}</div>
                        <div class="widget-subheading">{{this.text}}</div>
                      </div>
                      <div class="widget-content-right">
                        <button id="priorityUp{{@index}}" onclick="changePriority('{{this._id}}','up')"
                          class="border-0 btn-transition btn btn-outline-secondary">
                          <i class="fa-solid fa-arrow-up"></i>
                        </button>
                        <button id="priorityDown{{@index}}" onclick="changePriority('{{this._id}}','down')"
                          class="border-0 btn-transition btn btn-outline-secondary">
                          <i class="fa-solid fa-arrow-down"></i>
                        </button>
                        <button class="border-0 btn-transition btn btn-outline-primary" data-toggle="modal"
                          data-target="#Modal{{@index}}">
                          <i class="fa-solid fa-ellipsis" style="color: black;"></i>
                        </button>
                        <button id="delete{{@index}}" onclick="deleteTask('{{this._id}}')"
                          class="border-0 btn-transition btn btn-outline-danger">
                          <i class="fa fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </li>
                {{/each}}
              </ul>
            </div>
          </div>
        </perfect-scrollbar>
      </div>
      <div div class="d-block text-right card-footer">
        <button onclick="logout()" class="mr-2 btn btn-link btn-sm">Log out</button>
        <button class="btn btn-primary" data-toggle="modal" data-target="#addModal">Add Task</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll("[completed]").forEach(e => {
    e.checked = e.getAttribute("completed") == "true"
  })

  function parseCookie(str) {
    return str
      .split(';')
      .map(v => v.split('='))
      .reduce((acc, v) => {
        acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
        return acc;
      }, {});
  }

  function logout() {
    document.cookie = "Authorization=; Path=/;"
    window.location.href = "/"
  }

  function addTask() {
    if (document.querySelector("#addTitle").value == "") return toastr.error("Title field is required")
    let body = {
      title: document.querySelector("#addTitle").value,
      text: document.querySelector("#addDescription").value,
      timeEstimate: document.querySelector("#addEstimated").value,
      starTime: document.querySelector("#addStart").value,
      endTime: document.querySelector("#addEnd").value,
      imageURL: document.querySelector("#addImage").value
    }
    Object.keys(body).forEach(key=>{
      if(body[key]=="") delete body[key]
    });
    let requestOptions = {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "Authorization": parseCookie(document.cookie).Authorization
      },
      body: JSON.stringify(body)
    };
    let status = 0;
    fetch("{{API_URL}}" + "/api/tasks", requestOptions)
      .then(response => {
        status = response.status
        return response.text()
      })
      .then(result => {
        switch (status) {
          case 201:
            location.reload()
            break;
          default:
            toastr.error(JSON.parse(result).message)
            break;
        }
      })
      .catch(error => toastr.error(error));
  }

  function deleteTask(idTask) {
    let requestOptions = {
      method: 'DELETE',
      headers: {
        "Authorization": parseCookie(document.cookie).Authorization
      }
    };
    let status = 0;
    fetch("{{API_URL}}" + "/api/tasks?idTask=" + idTask, requestOptions)
      .then(response => {
        status = response.status
        return response.text()
      })
      .then(result => {
        switch (status) {
          case 200:
            location.reload()
            break;
          default:
            toastr.error(JSON.parse(result).message)
            break;
        }
      })
      .catch(error => toastr.error(error));
  }

  function changeCompleted(idTask, checkbox) {
    let checked = checkbox.checked;
    let requestOptions = {
      method: 'PUT',
      headers: {
        "Content-Type": "application/json",
        "Authorization": parseCookie(document.cookie).Authorization
      },
      body: JSON.stringify({
        completed: checked
      })
    };
    let status = 0;
    fetch("{{API_URL}}" + "/api/tasks?idTask=" + idTask, requestOptions)
      .then(response => {
        status = response.status
        return response.text()
      })
      .then(result => {
        if (status != 200) toastr.error(JSON.parse(result).message)
      })
      .catch(error => toastr.error(error));
  }

  function changePriority(idTask, type) {
    let requestOptions = {
      method: 'POST',
      headers: {
        "Authorization": parseCookie(document.cookie).Authorization,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idTask,
        type
      })
    };
    let status = 0;
    fetch("{{API_URL}}" + "/api/tasks/priority", requestOptions)
      .then(response => {
        status = response.status
        return response.text()
      })
      .then(result => {
        switch (status) {
          case 200:
            location.reload()
            break;
          case 500:
            toastr.error("Action not permited")
            break;
          default:
            toastr.error(JSON.parse(result).message)
            break;
        }
      })
      .catch(error => toastr.error(error));
  }
</script>